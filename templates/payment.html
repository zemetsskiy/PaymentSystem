<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Details</title>
    <link rel="stylesheet" type="text/css" href="static/index.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<h1>Payment Details</h1>

<div id="discord-info">
    {% if session['username'] %}
        <p>Authorized as: {{ session['username'] }}</p>
        <button type="button" id="next-button" onclick="goToNextStep()">Next</button>
    {% else %}
    <form action="/login/discord" method="post">
        <button type="submit">Authorize with Discord</button>
    </form>
    {% endif %}
</div>

<div id="data-form">
<form id="payment-form">
    <label for="email">Your Email:</label><br>
    <input type="email" id="email" name="email" value="{{ session['email'] if session['email'] else '' }}" required><br>
</form>
</div>

<div id="payment-details-form" style="display: none;">
    <label for="network">Choose a network:</label><br>
    <select name="network" id="network">
        <option value="ethereum">Ethereum</option>
        <option value="polygon">Polygon</option>
        <option value="arbitrum">Arbitrum</option>
        <option value="sepolia">Sepolia</option>
    </select><br>

    <label for="token">Choose a token:</label><br>
    <select name="token" id="token">
        <option value="eth">ETH</option>
        <option value="usdc">USDC</option>
        <option value="usdt">USDT</option>
    </select><br>
    <button type="button" onclick="submitPaymentForm()">Submit</button>
</div>

<div id="payment-checkout" style="display: none;">
    <div id="wallet-info">
        <p>Отправьте средства в размере <p id="amount-to-send">{{amount}}</p> <p id="token-to-send">{{token}}</p> на следующий EVM-кошелек:</p>
        <p id="wallet-address"><strong></strong></p>
    </div>

    <div id="payment-status">
        <p>Ожидание подтверждения платежа...</p>
    </div>
</div>

<script type="text/javascript">

    function onDiscordAuthorized(username) {
        $('#discord-auth').hide();
        $('#username').text(username);
        $('#user-info').show();
    }

    function goToNextStep() {
    $('#data-form').hide();
    $('#discord-info').hide();


    $('#payment-details-form').show();
    }

    function showPaymentForm() {
        document.getElementById('payment-details-form').style.display = 'block';
        document.getElementById('next-button').style.display = 'none';
    }

    function submitPaymentForm() {
        var network = $('#network').val();
        var token = $('#token').val();

        $.ajax({
            url: '/payment',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ network: network, token: token }),
            success: function(response) {
                  document.getElementById('payment-checkout').style.display = 'block';
                  document.getElementById('payment-details-form').style.display = 'none';
                  $('#wallet-address').text(response.wallet_address);
                  $('#amount-to-send').text(response.amount);
                  $('#token-to-send').text(response.token);
                  checkPaymentStatus();
            },
            error: function() {
                alert('Ошибка при отправке данных формы. Пожалуйста, попробуйте снова.');
            }
        });
    }

    function submitPaymentDetails() {
        var token = $('#token').val();
        var network = $('#network').val();
        var amount = $('#amount').val();

        $.ajax({
            url: '/payment',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ token: token, network: network, amount: amount }),
            success: function(response) {
                $('#wallet-address').text(response.wallet_address);
                $('#wallet-info').show();
                $('#payment-form').hide();
                checkPaymentStatus();
            },
            error: function() {
                alert('Ошибка при обработке ваших платёжных данных. Пожалуйста, попробуйте снова.');
            }
        });
    }

function checkPaymentStatus() {
  $.getJSON('/check_payment_status', function(data) {
    if (data.payment_confirmed) {
      $('#payment-status').text('Успех. Мы получили ваши средства. Переадресация...');
      setTimeout(function() {
        window.location.href = '/';
      }, 3000);
    } else if (data.payment_timeout) {
      $('#payment-status').text('Мы не получили ваши средства в течение 10 минут. Редирект...');
      setTimeout(function() {
        window.location.href = '/';
      }, 3000);
    } else if (data.error) {
      $('#payment-status').text('Ошибка платежной сессии. ' + data.error);
    } else {
      $('#payment-status').text('Ожидание подтверждения платежа...');
      setTimeout(checkPaymentStatus, 10000);
    }
  }).fail(function() {
    $('#payment-status').text('Ошибка при проверке статуса платежа. Повторите попытку позже.');
    setTimeout(checkPaymentStatus, 10000);
  });
}
</script>
</body>
</html>